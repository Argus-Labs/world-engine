import { Callout } from 'nextra/components'

# World

The `World` object is the manager of everything happening in the game. It deals with registering components, systems, transactions, and reads, as well as ticking the game simulation forward. `World` objects use [Redis](https://redis.io/) to store the game's state.


```go
package main

import (
    "log"

    "pkg.world.dev/world-engine/cardinal/ecs"
)

func main() {
    redisAddr := os.Getenv("redis_address")
    redisStore := storage.NewRedisStorage(storage.Options{Addr: redisAddr}, "my-world")

    worldStore := storage.NewWorldStorage(&redisStore)

    world, err := ecs.NewWorld(
		worldStore,
		ecs.WithNamespace("my-world"),
		ecs.WithReceiptHistorySize(10),
	)
    if err != nil {
        log.Fatal(err)
    }
}
```

## NewWorld

`NewWorld` creates a new `World` object.

```go
func NewWorld(s storage.WorldStorage, opts ...Option) (*World, error)
```

### Parameters
| Parameter | Type                        | Description                                               |
|-----------|-----------------------------|-----------------------------------------------------------|
| s         | storage.WorldStorage       | The storage backend to be used for the world.             |
| opts      | ...Option                  | Optional functional options for configuring the world.    |

### Return Values

| Type  | Description                                      |
|--------------|--------------------------------------------------|
| *World       | A pointer to the newly created World instance.  |
| error        | An error indicating any issues during creation. |

### Options

#### WithAdapter

The `WithAdapater` world option enables `World` objects to read transactions from the sequencer (EVM base shard), and rebuild game state from those transactions. When running World Engine in production, the `WithAdapter` option must be used.

```go
func WithAdapter(adapter shard.Adapter) Option
```

| Parameter | Type              | Description                              |
|-----------|-------------------|------------------------------------------|
| adapter   | shard.Adapter     | The adapter to be associated with World. |

#### WithReceiptHistorySize

The `WithReceiptHistorySize` option informs the `World` object on how many ticks the `World` should keep receipts for. For example, if we are on tick 40, and have a receipt history size of 5, the `World` will have receipts for ticks 35-39. On tick 41, the `World` will have receipts for ticks 36-40.

```go
func WithReceiptHistorySize(size int) Option
```

| Parameter | Type     | Description                                           |
|-----------|----------|-------------------------------------------------------|
| size      | int      | The size of the receipt history to be set for World. |


#### WithNamespace

The `WithNamespace` allows the `World` to have a custom Namespace. Namespaces are used to differentiate `World` objects that post data to the EVM base shard.

```go
func WithNamespace(id string) Option
```
| Parameter | Type    | Description                                   |
|-----------|---------|-----------------------------------------------|
| ns        | string  | The namespace to be set for World. |


## Methods

### AddSystems

`AddSystems` adds one or more systems to the `World`. Systems are executed in the order of which they were added to the world.

```go
func (w *World) AddSystems(s ...System)
```

#### Example

```go
package main

import (
    "pkg.world.dev/world-engine/cardinal/ecs"

    "github.com/my-username/my-world-engine-project/systems"
)

func main() {
    // ... world setup ...

	// Systems will run in order in which they are added:
	// 1. MoveSystem
	// 2. HealthRegenSystem
	// 3. AttackSystem
    world.AddSystems(systems.MoveSystem, systems.HealthRegenSystem, systems.AttackSystem)
}
```

#### Parameters

| Parameter | Type         | Description                                             |
|-----------|--------------|---------------------------------------------------------|
| s         | ...System    | Variadic parameter for systems to be added to the World. |


### RegisterComponents

`RegisterComponents` registers one or more components to the `World`. Upon registration, components are assigned an ID. IDs are assigned incrementally, starting from 0, in the order in which they were passed to the method.


<Callout type={"warning"}>
    `RegisterComponents` can be only be called once. Subsequent calls to the method will return an error.
</Callout>


```go
func (w *World) RegisterComponents(components ...component.IComponentType) error
```
#### Example

```go
package main

import (
	"log"

    "pkg.world.dev/world-engine/cardinal/ecs"

    "github.com/my-username/my-world-engine-project/components"
)

func main() {
    // ... world setup ...

    err := world.RegisterComponents(
		components.LocationComponent,
		components.AttackPowerComponent,
		components.HealthComponent,
	)
	if err != nil {
		log.Fatal(err)
	}
}
```

#### Parameters

| Parameter    | Type                    | Description                                                    |
|--------------|-------------------------|----------------------------------------------------------------|
| components   | ...component.IComponentType | Variadic parameter for components to be registered with the World. |

#### Return Value

| Type | Description                                                                  |
|-------------|------------------------------------------------------------------------------|
| error       | An error indicating any issues that occurred during the component registration. |


### RegisterReads

`RegisterReads` registers the reads in the `World`. This allows the `Read` endpoints to be automatically generated.

```go
func (w *World) RegisterReads(reads ...IRead) error
```
#### Example

```go
package main

import (
	"log"

    "pkg.world.dev/world-engine/cardinal/ecs"

    "github.com/my-username/my-world-engine-project/reads"
)

func main() {
    // ... world setup ...

    err := world.RegisterReads(
		reads.ReadLocation,
		reads.ReadHealth,
		reads.ReadAttackPower,
	)
	if err != nil {
		log.Fatal(err)
	}
}
```
#### Parameters
| Parameter    | Type       | Description                                                   |
|--------------|------------|---------------------------------------------------------------|
| reads        | ...IRead   | Variadic parameter for IRead instances to be registered.      |


#### Return Value
| Type   | Description                                                               |
|--------|---------------------------------------------------------------------------|
| error  | An error indicating any issues that occurred during the read registration. |

### RegisterTransactions

`RegisterTransactions` registers the transactions in the `World`. This allows transaction endpoints to be automatically generated.

<Callout type={"warning"}>
    `RegisterTransactions` can be only be called once. Subsequent calls to the method will return an error.
</Callout>

```go
func (w *World) RegisterTransactions(txs ...transaction.ITransaction) error
```

#### Example
```go
package main

import (
	"log"

    "pkg.world.dev/world-engine/cardinal/ecs"

    "github.com/my-username/my-world-engine-project/txs"
)

func main() {
    // ... world setup ...

    err := world.RegisterTransactions(
		txs.MoveTx,
		txs.AttackTx,
	)
	if err != nil {
		log.Fatal(err)
	}
}
```

#### Parameters
| Parameter        | Type                | Description                                                    |
|------------------|---------------------|----------------------------------------------------------------|
| txs              | ...transaction.ITransaction | Variadic parameter for ITransaction instances to be registered. |

#### Return Value
| Type   | Description                                                               |
|--------|---------------------------------------------------------------------------|
| error  | An error indicating any issues that occurred during the transaction registration. |


### CreateMany

`CreateMany` creates a specified amount of entities with a specified set of components.

```go
func (w *World) CreateMany(num int, components ...component.IComponentType) ([]storage.EntityID, error)
```

#### Example
```go
package main

import (
	"log"

    "pkg.world.dev/world-engine/cardinal/ecs"

    "github.com/my-username/my-world-engine-project/components"
)

func main() {
    // ... world setup ...

	// create 10 entities with the location and health component.
    entityIDs, err := world.CreateMany(
		10,
		components.LocationComponent,
		components.HealthComponent,
	)
	if err != nil {
		log.Fatal(err)
	}
}
```

#### Parameters

| Parameter    | Type                | Description                                                                                               |
|--------------|---------------------|-----------------------------------------------------------------------------------------------------------|
| num          | int                 | The number of entities to create.                                                                        |
| components   | ...component.IComponentType | Variadic parameter for components to associate with the created entities.                             |

#### Return Values

| Type             | Description                                                                   |
|------------------|-------------------------------------------------------------------------------|
| []storage.EntityID | A slice of storage.EntityID representing the IDs of the created entities.    |
| error            | An error indicating any issues that occurred during the creation process.  |

### Create

`Create` creates a single entity with a given set of components.

```go
func (w *World) Create(components ...component.IComponentType) (storage.EntityID, error)
```

#### Example
```go
package main

import (
	"log"

    "pkg.world.dev/world-engine/cardinal/ecs"

    "github.com/my-username/my-world-engine-project/components"
)

func main() {
    // ... world setup ...

	// create an entity with the location and health component.
    entityID, err := world.Create(
		components.LocationComponent,
		components.HealthComponent,
	)
	if err != nil {
		log.Fatal(err)
	}
}
```

#### Parameters
| Parameter    | Type                | Description                                                                                               |
|--------------|---------------------|-----------------------------------------------------------------------------------------------------------|
| components   | ...component.IComponentType | Variadic parameter for components to associate with the created entity.                               |


#### Return Values
| Type             | Description                                                                   |
|------------------|-------------------------------------------------------------------------------|
| storage.EntityID | The ID of the created entity.                                                 |
| error            | An error indicating any issues that occurred during the creation process.  |



### Valid

`Valid` checks if a given entity exists within the `World`.

```go
func (w *World) Valid(id storage.EntityID) (bool, error)
```

#### Example
```go
package main

import (
	"log"

    "pkg.world.dev/world-engine/cardinal/ecs"

    "github.com/my-username/my-world-engine-project/components"
)

func main() {
    // ... world setup ...

	// create an entity with the location and health component.
    entityID, err := world.Create(
		components.LocationComponent,
		components.HealthComponent,
	)
	if err != nil {
		log.Fatal(err)
	}

	// ok = true, err = nil
	ok, err := world.Valid(entityID)
}
```
#### Parameters
| Parameter    | Type                   | Description                            |
|--------------|------------------------|----------------------------------------|
| id           | storage.EntityID       | The entity ID to check for validity.   |

#### Return Values

| Type   | Description                                                                              |
|--------|------------------------------------------------------------------------------------------|
| bool   | A boolean indicating whether the entity with the given ID is valid.                     |
| error  | An error indicating any issues that occurred during the validation process.            |


### Len

`Len` returns how many entities currenlty exist within the `World`.

```go
func (w *World) Len() (int, error)
```
### Remove

`Remove` removes a given entity from the `World`.

```go
func (w *World) Remove(id storage.EntityID) error
```

#### Example
```go
package main

import (
	"log"

    "pkg.world.dev/world-engine/cardinal/ecs"

    "github.com/my-username/my-world-engine-project/components"
)

func main() {
    // ... world setup ...

	// create an entity with the location and health component.
    entityID, err := world.Create(
		components.LocationComponent,
		components.HealthComponent,
	)
	if err != nil {
		log.Fatal(err)
	}

	// remove the entity we just created
	err = world.Remove(entityID)
		if err != nil {
		log.Fatal(err)
	}
}
```

#### Parameters
| Parameter    | Type                   | Description                                      |
|--------------|------------------------|--------------------------------------------------|
| id           | storage.EntityID       | The entity ID to be removed from the world.     |


#### Return Value
| Type   | Description                                                                                   |
|--------|-----------------------------------------------------------------------------------------------|
| error  | An error indicating any issues that occurred during the removal process.                   |

### StartGameLoop

`StartGameLoop` begins the game loop in a new Go routine. `StartGameLoop` runs a tick at a specified interval.

```go
func (w *World) StartGameLoop(ctx context.Context, loopInterval time.Duration)
```

#### Example
```go
world.StartGameLoop(ctx, time.Second * 1) // tick every second
```

#### Parameters
| Parameter      | Type                    | Description                                       |
|----------------|-------------------------|---------------------------------------------------|
| ctx            | context.Context         | The context for the game loop.                   |
| loopInterval   | time.Duration           | The interval at which the game loop should run.  |

### LoadGameState

`LoadGameState` loads any game state stored in the Redis instance. If no game state is stored, this method is a no-op.


<Callout type={"warning"}>
    `LoadGameState` must only be called once, and must be called after transactions and components are registered, else, an error will be returned.
</Callout>

```go
func (w *World) LoadGameState() error
```

### RecoverFromChain

`RecoverFromChain` will recover the `World` state from the EVM base shard, if and only if the adapter option was used when instantiating the `World`. This method cannot be called in the middle of a running `World` (i.e. when the tick is greater than 0).

```go
func (w *World) RecoverFromChain(ctx context.Context) error
```

#### Parameters

| Parameter      | Type                 | Description                                                                                                                                               |
|----------------|----------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------|
| ctx            | context.Context      | The context for the recovery process.                                                                                                                     |

#### Return Value
| Type   | Description                                                                               |
|--------|-------------------------------------------------------------------------------------------|
| error  | An error indicating any issues that occurred during the recovery process.                |


