package component

// LobbyState represents the current state of a lobby.
type LobbyState string

const (
	LobbyStateInGame LobbyState = "in_game" // Match active
	LobbyStateEnded  LobbyState = "ended"   // Game finished
)

// LobbyTeam represents a team in a matchmade lobby.
type LobbyTeam struct {
	TeamName string   `json:"team_name"`
	PartyIDs []string `json:"party_ids"`
}

// LobbyComponent is a container for parties throughout the game lifecycle.
// Created automatically when Match is received from Matchmaking Shard.
// Note: MatchID is the primary key - there is no separate lobby_id.
type LobbyComponent struct {
	// MatchID is the primary identifier for the lobby.
	// This is generated by Matchmaking Shard and used as the lobby key.
	MatchID string `json:"match_id"`

	// Parties is a flat list of party IDs in the lobby.
	Parties []string `json:"parties"`

	// Team assignments from Match
	Teams []LobbyTeam `json:"teams,omitempty"`

	// State is the current lobby state (in_game or ended).
	State LobbyState `json:"state"`

	// MatchProfileName from matchmaking (e.g., "1v1-ranked", "5v5-roles")
	MatchProfileName string `json:"match_profile_name,omitempty"`

	// Game configuration
	Config map[string]string `json:"config,omitempty"`

	// Disconnected parties (tracked during in_game, reported by Game Shard)
	DisconnectedParties []string `json:"disconnected_parties,omitempty"`

	// Timestamps (Unix seconds)
	CreatedAt     int64 `json:"created_at"`
	StartedAt     int64 `json:"started_at,omitempty"`
	LastHeartbeat int64 `json:"last_heartbeat,omitempty"`
}

// Name returns the component name for ECS registration.
func (LobbyComponent) Name() string { return "lobby" }

// HasTeams returns true if the lobby has team assignments.
func (l *LobbyComponent) HasTeams() bool {
	return len(l.Teams) > 0
}

// PartyCount returns the number of parties in the lobby.
func (l *LobbyComponent) PartyCount() int {
	return len(l.Parties)
}

// HasParty returns true if the given party is in the lobby.
func (l *LobbyComponent) HasParty(partyID string) bool {
	for _, p := range l.Parties {
		if p == partyID {
			return true
		}
	}
	return false
}

// GetTeamForParty returns the team name for a given party, or empty string if not found.
func (l *LobbyComponent) GetTeamForParty(partyID string) string {
	for _, team := range l.Teams {
		for _, pid := range team.PartyIDs {
			if pid == partyID {
				return team.TeamName
			}
		}
	}
	return ""
}

// IsDisconnected returns true if the party is marked as disconnected.
func (l *LobbyComponent) IsDisconnected(partyID string) bool {
	for _, p := range l.DisconnectedParties {
		if p == partyID {
			return true
		}
	}
	return false
}

// MarkDisconnected marks a party as disconnected.
func (l *LobbyComponent) MarkDisconnected(partyID string) {
	if !l.IsDisconnected(partyID) {
		l.DisconnectedParties = append(l.DisconnectedParties, partyID)
	}
}

// MarkConnected removes a party from the disconnected list.
func (l *LobbyComponent) MarkConnected(partyID string) {
	for i, p := range l.DisconnectedParties {
		if p == partyID {
			l.DisconnectedParties = append(l.DisconnectedParties[:i], l.DisconnectedParties[i+1:]...)
			return
		}
	}
}
